const express = require('express');
const bodyParser = require('body-parser');

const app = express();

// Use body-parser middleware to handle JSON payloads
app.use(bodyParser.json());

// SERVER ID
const SERVER_ID = "SERVER_1";

// Array of allowed RFID tag IDs
const allowedTagIDs = [
    "0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07 0x08 0x09 0x0A 0x0B",
    "0x0B 0x0A 0x09 0x08 0x07 0x06 0x05 0x04 0x03 0x02 0x01 0x00",
    "0x1A 0x1B 0x1C 0x1D 0x1E 0x1F 0x20 0x21 0x22 0x23 0x24 0x25",
    "0x25 0x24 0x23 0x22 0x21 0x20 0x1F 0x1E 0x1D 0x1C 0x1B 0x1A",
    "0x2A 0x2B 0x2C 0x2D 0x2E 0x2F 0x30 0x31 0x32 0x33 0x34 0x35",
    "0x35 0x34 0x33 0x32 0x31 0x30 0x2F 0x2E 0x2D 0x2C 0x2B 0x2A",
    "0x3A 0x3B 0x3C 0x3D 0x3E 0x3F 0x40 0x41 0x42 0x43 0x44 0x45",
    "0x45 0x44 0x43 0x42 0x41 0x40 0x3F 0x3E 0x3D 0x3C 0x3B 0x3A",
    "0x4A 0x4B 0x4C 0x4D 0x4E 0x4F 0x50 0x51 0x52 0x53 0x54 0x55",
    "0x55 0x54 0x53 0x52 0x51 0x50 0x4F 0x4E 0x4D 0x4C 0x4B 0x4A"
];

app.post('/', (req, res) => {
    const { DEV_ID, TAG_ID, OPERATION } = req.body;

    // Check if all fields are provided in the request
    if (!DEV_ID || !TAG_ID || !OPERATION) {
        return res.status(400).json({ error: 'All fields (DEV_ID, TAG_ID, OPERATION) are required.' });
    }

    // Determine ACCESS_STATUS based on the TAG_ID
    const ACCESS_STATUS = allowedTagIDs.includes(TAG_ID) ? "ALLOW" : "DENY";

    const response = {
        SERVER_ID,
        ACCESS_TYPE: OPERATION, // Assuming OPERATION will always be "ENTRY" or "EXIT"
        ACCESS_STATUS
    };

    // Log and send a response to the client
    console.log(response);
    res.status(200).json(response);
});

app.listen(4007, () => {
    console.log('Server is running on port 4007');
});